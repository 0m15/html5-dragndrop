<!DOCTYPE html>
<html>
    <head>
        <title>Test google closure stylesheets</title>
        <link rel="stylesheet" type="text/css" href="/css/chess.css" />
        <script type="text/javascript" src="/js/jquery-1.8.1.min.js"></script>
        <script type="text/javascript" src="/js/modernizr.dnd.js"></script>
        <script type="text/javascript">
            var dragged = null;
            var dropped = null;
            var debugging_object = null;
            var debugging = false;

            var squares = null;

            function debug(message) {
                if (debugging) {
                    console.log(message);
                }
            }

            function dragStartHandler(event) {
                debug('Drag START');
                debug(this.innerHTML);
                dragged = this;
                event.dataTransfer.effectAllowed = 'move';
                var dragIcon = document.createElement('img');
                dragIcon.src = getDragIcon(this);
                dragIcon.width = 100;
                event.dataTransfer.setDragImage(dragIcon, 22, 22);
                //event.dataTransfer.setData('text/html', this);
                return false;
            }

            function dragEnterHandler(event) {
                debug('Drag ENTER')
                debug(this);
                event.preventDefault();
                event.dataTransfer.dropEffect = 'move';
                return false;
            }

            function dragOverHandler(event) {
                debug('Drag OVER')
                debug(this);
                event.preventDefault();
                event.dataTransfer.dropEffect = 'move';
                return false;
            }

            function dragLeaveHandler(event) {
                debug('Drag LEAVE')
                debug(this);
                event.preventDefault();
                return false;
            }

            function handleDragEnd(event) {
                debug('Drag END');
                debug(this);
                event.preventDefault();
                return false;
            }

            function dropOnPieceHandler(event) {
                debug('DROP');
                debug(this.parent);
                dropped = this;
                if (event.stopPropagation) {
                    event.stopPropagation();
                }
                var parentNode = this.parentNode;
                this.parentNode.removeChild(this);
                parentNode.appendChild(dragged);
                return false;
            }

            function dropOnSquareHandler(event) {
                debug('DROP');
                debug(this);
                if (event.stopPropagation) {
                    event.stopPropagation();
                }
                this.appendChild(dragged);
                return false;
            }

            function setupDnDPieces(pieces) {
                [].forEach.call(pieces, function(piece) {
                    piece.setAttribute('draggable', 'true');
                    piece.addEventListener('dragstart', dragStartHandler, false);
                    piece.addEventListener('dragenter', dragEnterHandler, false);
                    piece.addEventListener('dragover', dragOverHandler, false);
                    piece.addEventListener('dragleave', dragLeaveHandler, false);
                    piece.addEventListener('drop', dropOnPieceHandler, false);
                });
            }

            function setupDndSquares(squares) {
                [].forEach.call(squares, function(square) {
                    square.addEventListener('dragenter', dragEnterHandler, false);
                    square.addEventListener('dragover', dragOverHandler, false);
                    square.addEventListener('dragleave', dragLeaveHandler, false);
                    square.addEventListener('drop', dropOnSquareHandler, false);
                    square.addEventListener('mouseover', getSquareInfo, false);
                });
            }

            function getDragIcon(element) {
                var css = document.defaultView.getComputedStyle(element);
                var background_image = css.backgroundImage;
                var start = background_image.indexOf('(') + 1;
                var end = background_image.indexOf(')') - start;
                return background_image.substr(start, end);
            }

            function getSquareInfo(event) {
                debug(event.target);
            }

            function clearBoard() {
                var pieces = document.querySelectorAll('.piece');
                [].forEach.call(pieces, function(piece) {
                    piece.parentNode.removeChild(piece);
                });
            }

            function loadFen() {
                var fen_string = document.getElementById('fen_string').value;
                if (validateFen(fen_string)) {
                    displayGameInfos(fen_string);
                    setupBoardPosition(fen_string);
                    document.getElementById('fen_string').value = '';
                }
                return false;
            }

            function displayGameInfos(fen_string) {
                var fen = fen_string.split(/\s+/);
                var ac_div = document.getElementById('active_color').setAttribute('class', fen[1] + '_turn');
                document.getElementById('castling').textContent = fen[2];
            }

            function setupBoardPosition(fen_string) {
                clearBoard();
                debug("Setting up the board");
                var fen = fen_string.split(/\s+/);
                var pieces_position = fen[0];
                var ranks = pieces_position.split('/');
                for (rank_index = 0; rank_index < ranks.length; rank_index++) {
                    var rank = ranks[rank_index];
                    var number = 0
                    for (i = 0; i < rank.length; i++) {
                        if (isNaN(rank[i])) {
                            placePiece(rank[i], rank_index, number);
                            number += 1
                        } else {
                            number += parseInt(rank[i]);
                        }
                    }
                }
                var pieces = document.querySelectorAll('.piece');
                setupDnDPieces(pieces);
            }

            function placePiece(piece, inverted_rank, column) {
                var column_table = {
                    0: 'a', 1: 'b', 2: 'c', 3: 'd',
                    4: 'e', 5: 'f', 6: 'g', 7: 'h'
                };
                var rank_table = {0: 8, 1: 7, 2: 6, 3: 5, 4: 4, 5: 3, 6: 2, 7: 1};
                var piece_table = {
                    'P': 'piece white_pawn', 'R': 'piece white_rook',
                    'N': 'piece white_knight', 'B': 'piece white_bishop',
                    'Q': 'piece white_queen', 'K': 'piece white_king',
                    'p': 'piece black_pawn', 'r': 'piece black_rook',
                    'n': 'piece black_knight', 'b': 'piece black_bishop',
                    'q': 'piece black_queen', 'k': 'piece black_king'
                };
                var piece_column = column_table[column];
                var piece_rank = rank_table[inverted_rank];
                var piece_class = piece_table[piece];

                var piece_div = document.createElement('div');
                piece_div.setAttribute('class', piece_class);
                piece_div.setAttribute('draggable', 'true');
                [].forEach.call(squares, function(square) {
                    var square_rank = square.getAttribute('rank');
                    var square_column = square.getAttribute('column');
                    if ((parseInt(square_rank) == piece_rank) && (square_column == piece_column)) {
                        square.appendChild(piece_div);
                    }
                });
            }

            function validateFen(fen_string) {
                function validatePiecesPosition(pieces_position) {
                    var ranks = pieces_position.split('/');
                    // eigth fields one per rank separated by a '/'
                    if (ranks.length != 8) {
                        return false;
                    }

                    for (var i = 0; i < ranks.length; i++) {
                        var sum_fields = 0;
                        var previous_was_number = false;

                        for (var k = 0; k < ranks[i].length; k++) {
                            if (!isNaN(ranks[i][k])) {
                                if (previous_was_number) {
                                    return false;
                                }
                                sum_fields += parseInt(ranks[i][k]);
                                previous_was_number = true;
                            } else {
                                if (!/^[prnbqkPRNBQK]$/.test(ranks[i][k])) {
                                    return false;
                                }
                                sum_fields += 1;
                                previous_was_number = false;
                            }
                        }
                        if (sum_fields != 8) {
                            return false;
                        }
                    }
                    return true;
                }

                function validateActiveColor(active_color) {
                    if (active_color == 'w' || active_color == 'b') {
                        return true;
                    } else {
                        return false;
                    }
                }

                function validateCastling(castling) {
                    if (!(/^(K?Q?k?q?|-)$/.test(castling) && (castling.length > 0))) {
                        return false;
                    } else {
                        return true;
                    }
                }

                function validateEnPassant(enpassant) {
                    if (!/^(-|[abcdefgh][36])$/.test(enpassant)) {
                        return false;
                    } else {
                        return true;
                    }
                }

                function validateHalfmoveClock(halfmove_clock) {
                    if (isNaN(halfmove_clock) || (parseInt(halfmove_clock, 10) < 0)) {
                        return false;
                    } else {
                        return true;
                    }
                }

                function validateFullmoveNumber(fullmove_number) {
                    if (isNaN(fullmove_number) || (parseInt(fullmove_number, 10) <= 0)) {
                        return {valid: false, error_number: 2, error: errors[2]};
                    } else {
                        return true;
                    }
                }

                var fen = fen_string.split(/\s+/);
                if (fen.length != 6) {
                    debug("FEN is more than 6 fields");
                    return false;
                }

                var pieces_position = fen[0];
                if (!validatePiecesPosition(pieces_position)) {
                    debug("FEN has wrong piece positions");
                    return false;
                }

                var active_color = fen[1];
                if (!validateActiveColor(active_color)) {
                    debug("FEN has wrong active color field");
                    return false;
                }

                var castling = fen[2];
                if (!validateCastling(castling)) {
                    debug("FEN has wrong castling field");
                    return false;
                }
                var enpassant = fen[3];
                if (!validateEnPassant(enpassant)) {
                    debug("FEN has wrong enpassant field");
                    return false;
                }

                var halfmove_clock = fen[4];
                if (!validateHalfmoveClock(halfmove_clock)) {
                    debug("FEN has wrong halfmove clock field");
                    return false;
                }

                var fullmove_number = fen[5];
                if (!validateFullmoveNumber(fullmove_number)) {
                    debug("FEN has wrong fullmove field");
                    return false;
                }
                debug("FEN is VALID");
                return true;
            }
            $(document).ready(function() {
                if (!Modernizr.draganddrop) {
                    $('body').html("<h1>Your browser doesn't support HTML5 Drag'n'Drop, go get another one!</h1>")
                    return false;
                }
                var pieces = document.querySelectorAll('.piece');
                setupDnDPieces(pieces);
                squares = document.querySelectorAll('.square');
                setupDndSquares(squares);

            });

        </script>
    </head>
    <body id="wrapper">
        <button id="clear_board" type="button" onclick="clearBoard();">Clear Board</button>
        <form>
            FEN: <input id="fen_string" type="text" name="fen" />
            <input type="submit" value="Load FEN" onclick="loadFen(); return false;"/>
        </form>
        <div id="game_info">
            Move: <div id="active_color" class="w_turn"></div>
            Castling: <div id="castling">KQkq</div>
        </div>
        <table class="board">
            <tr>
                <td class="border-corner"></td>
                <td class="border-square"></td>
                <td class="border-square"></td>
                <td class="border-square"></td>
                <td class="border-square"></td>
                <td class="border-square"></td>
                <td class="border-square"></td>
                <td class="border-square"></td>
                <td class="border-square"></td>
                <td class="border-corner"></td>
            </tr>
            <tr>
                <td class="border-side"></td>
                <td column="a" rank="8" class="square white"><div class="piece black_rook"></div></td>
                <td column="b" rank="8" class="square black"><div class="piece black_knight"></div></td>
                <td column="c" rank="8" class="square white"><div class="piece black_bishop"></div></td>
                <td column="d" rank="8" class="square black"><div class="piece black_queen"></div></td>
                <td column="e" rank="8" class="square white"><div class="piece black_king"></div></td>
                <td column="f" rank="8" class="square black"><div class="piece black_bishop"></div></td>
                <td column="g" rank="8" class="square white"><div class="piece black_knight"></div></td>
                <td column="h" rank="8" class="square black"><div class="piece black_rook"></div></td>
                <td class="border-side"></td>
            </tr>
            <tr>
                <td class="border-side"></td>
                <td column="a" rank="7" class="square black"><div class="piece black_pawn"></div></td>
                <td column="b" rank="7" class="square white"><div class="piece black_pawn"></div></td>
                <td column="c" rank="7" class="square black"><div class="piece black_pawn"></div></td>
                <td column="d" rank="7" class="square white"><div class="piece black_pawn"></div></td>
                <td column="e" rank="7" class="square black"><div class="piece black_pawn"></div></td>
                <td column="f" rank="7" class="square white"><div class="piece black_pawn"></div></td>
                <td column="g" rank="7" class="square black"><div class="piece black_pawn"></div></td>
                <td column="h" rank="7" class="square white"><div class="piece black_pawn"></div></td>
                <td class="border-side"></td>
            </tr>
            <tr>
                <td class="border-side"></td>
                <td column="a" rank="6" class="square white"></td>
                <td column="b" rank="6" class="square black"></td>
                <td column="c" rank="6" class="square white"></td>
                <td column="d" rank="6" class="square black"></td>
                <td column="e" rank="6" class="square white"></td>
                <td column="f" rank="6" class="square black"></td>
                <td column="g" rank="6" class="square white"></td>
                <td column="h" rank="6" class="square black"></td>
                <td class="border-side"></td>
            </tr>
            <tr>
                <td class="border-side"></td>
                <td column="a" rank="5" class="square black"></td>
                <td column="b" rank="5" class="square white"></td>
                <td column="c" rank="5" class="square black"></td>
                <td column="d" rank="5" class="square white"></td>
                <td column="e" rank="5" class="square black"></td>
                <td column="f" rank="5" class="square white"></td>
                <td column="g" rank="5" class="square black"></td>
                <td column="h" rank="5" class="square white"></td>
                <td class="border-side"></td>
            </tr>
            <tr>
                <td class="border-side"></td>
                <td column="a" rank="4" class="square white"></td>
                <td column="b" rank="4" class="square black"></td>
                <td column="c" rank="4" class="square white"></td>
                <td column="d" rank="4" class="square black"></td>
                <td column="e" rank="4" class="square white"></td>
                <td column="f" rank="4" class="square black"></td>
                <td column="g" rank="4" class="square white"></td>
                <td column="h" rank="4" class="square black"></td>
                <td class="border-side"></td>
            </tr>
            <tr>
                <td class="border-side"></td>
                <td column="a" rank="3" class="square black"></td>
                <td column="b" rank="3" class="square white"></td>
                <td column="c" rank="3" class="square black"></td>
                <td column="d" rank="3" class="square white"></td>
                <td column="e" rank="3" class="square black"></td>
                <td column="f" rank="3" class="square white"></td>
                <td column="g" rank="3" class="square black"></td>
                <td column="h" rank="3" class="square white"></td>
                <td class="border-side"></td>
            </tr>
            <tr>
                <td class="border-side"></td>
                <td column="a" rank="2" class="square white"><div class="piece white_pawn"></div></td>
                <td column="b" rank="2" class="square black"><div class="piece white_pawn"></div></td>
                <td column="c" rank="2" class="square white"><div class="piece white_pawn"></div></td>
                <td column="d" rank="2" class="square black"><div class="piece white_pawn"></div></td>
                <td column="e" rank="2" class="square white"><div class="piece white_pawn"></div></td>
                <td column="f" rank="2" class="square black"><div class="piece white_pawn"></div></td>
                <td column="g" rank="2" class="square white"><div class="piece white_pawn"></div></td>
                <td column="h" rank="2" class="square black"><div class="piece white_pawn"></div></td>
                <td class="border-side"></td>
            </tr>
            <tr>
                <td class="border-side"></td>
                <td column="a" rank="1" class="square black"><div class="piece white_rook"></td>
                <td column="b" rank="1" class="square white"><div class="piece white_knight"></td>
                <td column="c" rank="1" class="square black"><div class="piece white_bishop"></td>
                <td column="d" rank="1" class="square white"><div class="piece white_queen"></td>
                <td column="e" rank="1" class="square black"><div class="piece white_king"></td>
                <td column="f" rank="1" class="square white"><div class="piece white_bishop"></td>
                <td column="g" rank="1" class="square black"><div class="piece white_knight"></td>
                <td column="h" rank="1" class="square white"><div class="piece white_rook"></td>
                <td class="border-side"></td>
            </tr>
            <tr>
                <td class="border-corner"></td>
                <td class="border-square"></td>
                <td class="border-square"></td>
                <td class="border-square"></td>
                <td class="border-square"></td>
                <td class="border-square"></td>
                <td class="border-square"></td>
                <td class="border-square"></td>
                <td class="border-square"></td>
                <td class="border-corner"></td>
            </tr>
        </table>
    </body>

</html>
